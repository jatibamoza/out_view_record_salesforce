<!doctype html>
<html lang="es">
	<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Siigo Lightning Out</title>
		<!-- Carga el runtime desde tu Experience -->
		<script src="{{ site_domain }}/lightning/lightning.out.js"></script>
		<style>
			body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
			.container { max-width: 1100px; margin: 24px auto; padding: 0 12px; }
		</style>
	</head>
	<body>
		<div class="container">
			<h2>Siigo Record Viewer (Lightning Out)</h2>
			<div id="siigo_container"></div>
		</div>
		<script>
			// 1) captura de errores globales
			window.addEventListener('error',    e => console.error('[window.error]', e.error || e.message));
			window.addEventListener('unhandledrejection', e => console.error('[unhandledrejection]', e.reason));
			const recordId   = "{{ record_id }}";
			// 2) helper: usar Lightning Out con timeout y catch
			function useLightning(appName, endpoint, timeoutMs = 15000) {
				return new Promise((resolve, reject) => {
					let done = false;
					const t = setTimeout(() => {
						if (!done) reject(new Error('Lightning Out timed out (' + timeoutMs + 'ms)'));
					}, timeoutMs);

					try {
						$Lightning.use(appName, () => {
							done = true; clearTimeout(t);
							resolve();                      // listo para crear componentes
						}, endpoint);
					} catch (err) {
						done = true; clearTimeout(t);
						reject(err);
					}
				});
			}

			// 3) helper: crear componente con try/catch
			function createLoComponent(def, attrs, containerId) {
				return new Promise((resolve, reject) => {
					try {
						$Lightning.createComponent(def, attrs, containerId, cmp => resolve(cmp));
					} catch (err) {
						reject(err);
					}
				});
			}

			// 4) uso con manejo de error
			(async function bootstrap() {
				const endpoint = "https://s11g0--core.sandbox.my.site.com/recordviewerapp";
				try {
					await useLightning("c:SIIGO_OutUiRecordViewerApp_AUR", endpoint);
					await createLoComponent(
						"c:SIIGO_UiRecordViewerHost_AUR",
						{
							recordId: recordId
						},
						"siigo_container"
					);
					console.log('Lightning Out OK');
				} catch (err) {
					console.error('Lightning Out ERROR:', err);
					// mensaje visible para el usuario
					const el = document.getElementById('siigo_container');
					if (el) el.innerHTML = '<div style="color:#c23934">No fue posible cargar la app. Error: '+ err +'.</div>';
				}
			})();
		</script>
	</body>
</html>