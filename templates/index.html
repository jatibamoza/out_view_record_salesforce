<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Lightning Out</title>
	</head>
	<body>
		<div id="lightning_out_container"></div>

		<script>
			const ENDPOINT 	= "{{ site_domain }}"; // tu site Aura (no el core)
			const CORE    	= "{{ base_domain }}";  // para baseDomain (botonera)
			const recordId  = "{{ record_id }}";
			// 1) Cargar lightning.out.js y esperar a que esté listo
			function loadLightningOut(endpoint, timeoutMs = 15000) {
				console.log("2.Endpoint: ",ENDPOINT);
				console.log("3.recordId: ",recordId);
				return new Promise((resolve, reject) => {
					const src = endpoint.replace(/\/+$/,'') + "/lightning/lightning.out.js";
					const s = document.createElement("script");
					let done = false;
					const t = setTimeout(() => {
						if (!done) reject(new Error("Timeout cargando lightning.out.js"));
					}, timeoutMs);

					s.onload = () => {
						done = true; clearTimeout(t);
						if (window.$Lightning) resolve();
						else reject(new Error("$Lightning no quedó definido tras cargar el script"));
					};
					s.onerror = () => { done = true; clearTimeout(t); reject(new Error("No se pudo cargar lightning.out.js")); };
					document.head.appendChild(s);
					s.src = src;
				});
			}

			// 2) Usar Lightning Out (envuelto en Promesa)
			function useLightning(appName, endpoint, timeoutMs = 15000) {
				return new Promise((resolve, reject) => {
					let done = false;
					const t = setTimeout(() => { if (!done) reject(new Error("Lightning.use timeout")); }, timeoutMs);
					try {
						$Lightning.use(appName, () => { done = true; clearTimeout(t); resolve(); }, endpoint);
					} 
					catch (e) { done = true; clearTimeout(t); reject(e); }
				});
			}

			function createLoComponent(def, attrs, containerId) {
				return new Promise((resolve, reject) => {
					try { 
						$Lightning.createComponent(def, attrs, containerId, cmp => resolve(cmp)); 
					}
					catch (e) { reject(e); }
				});
			}

			// 3) Bootstrap con manejo de errores
			(async function init() {
				console.log("2.Endpoint: ",ENDPOINT);
				console.log("3.recordId: ",recordId);
				try {
					await loadLightningOut(ENDPOINT);            // garantiza $Lightning
					await useLightning("c:SIIGO_OutUiRecordViewerApp_AUR", ENDPOINT);
					await createLoComponent(
						"c:SIIGO_UiRecordViewerHost_AUR",
						{ recordId: recordId },
						"lightning_out_container"
					);
					console.log("Lightning Out OK");
				} catch (err) {
					console.error("Lightning Out ERROR:", err);
					document.getElementById("lightning_out_container").innerHTML =
					'<div style="color:#c23934">No fue posible cargar la app. Error: '+ err +'.</div>';
				}
			})();

			// 4) Logs globales útiles
			window.addEventListener('error', e => console.error('[window.error]', e.error || e.message));
			window.addEventListener('unhandledrejection', e => console.error('[unhandledrejection]', e.reason));
		</script>
	</body>
</html>
