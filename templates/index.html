<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Lightning Out – Record Viewer</title>
		<style>
		body{font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0}
		.wrap{max-width:1100px;margin:24px auto;padding:0 12px}
		#status{padding:8px 0}
		</style>
	</head>
	<body>
		<div class="wrap">
		<h2>Record Viewer (Lightning Out)</h2>
		<div id="status">Cargando…</div>
		<div id="mi_container"></div>
	</div>
		<script>
			// Valores inyectados por Flask
			const ENDPOINT   = "{{ site_domain }}";         // p.ej. https://...my.site.com/recordviewerapp
			const BASE_CORE  = "{{ base_domain }}";         // p.ej. https://...lightning.force.com
			const RECORD_ID  = "{{ record_id }}";           // ← viene del querystring ?id=
			const OBJECT_API = "{{ object_api }}";          // ← ?object=Lead|Account|desconocido

			const APP_NAME = "c:SIIGO_OutUiRecordViewerApp_AUR"; // tu Aura App (GLOBAL)
			const HOST_DEF = "c:SIIGO_UiRecordViewerHost_AUR";        // tu Aura host (GLOBAL)

			function setStatus(msg, isErr=false){
				const s = document.getElementById('status');
				s.textContent = (isErr ? "⚠️ " : "✅ ") + msg;
				s.style.color = isErr ? "#b00020" : "inherit";
			}

			function loadLightningOut(timeoutMs=15000){
				return new Promise((resolve,reject)=>{
					const src = ENDPOINT.replace(/\/+$/,'') + "/lightning/lightning.out.js";
					const s = document.createElement("script");
					let done=false;
					const t=setTimeout(()=>{ if(!done) reject(new Error("Timeout cargando lightning.out.js")); }, timeoutMs);
					s.onload = ()=>{ done=true; clearTimeout(t); if(window.$Lightning) resolve(); else reject(new Error("$Lightning no definido")); };
					s.onerror= ()=>{ done=true; clearTimeout(t); reject(new Error("No se pudo cargar lightning.out.js")); };
					document.head.appendChild(s);
					s.src = src;
				});
			}

			function useLightning(timeoutMs=15000){
				return new Promise((resolve,reject)=>{
					let done=false;
					const t=setTimeout(()=>{ if(!done) reject(new Error("Lightning.use timeout")); }, timeoutMs);
					try{
						$Lightning.use(APP_NAME, ()=>{ done=true; clearTimeout(t); resolve(); }, ENDPOINT);
					}catch(e){ done=true; clearTimeout(t); reject(e); }
				});
			}

			function createLoComponent(def, attrs, containerId){
				return new Promise((resolve,reject)=>{
				try{
					$Lightning.createComponent(def, attrs, containerId, cmp=>resolve(cmp));
				}catch(e){ reject(e); }
				});
			}

			(async function init(){
				try{
					await loadLightningOut();
					await useLightning();
					await createLoComponent(
						HOST_DEF,
						{ recordId: RECORD_ID },
						"mi_container"
					);
					setStatus("Lightning Out inicializado.");
				}catch(err){
					console.error("Lightning Out ERROR:", err);
					setStatus("No fue posible inicializar Lightning Out. Revisa CSP en Render y Trusted Sites/CORS en Salesforce.", true);
				}
			})();

			// logs útiles
			window.addEventListener('error', e => console.error('[window.error]', e.error || e.message));
			window.addEventListener('unhandledrejection', e => console.error('[unhandledrejection]', e.reason));
		</script>
	</body>
</html>
